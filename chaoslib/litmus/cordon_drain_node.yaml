- block:

  - name: Identify the application node
    shell: >
      kubectl get pod {{ app_pod }} -n {{ app_ns }} 
      --no-headers -o custom-columns=:spec.nodeName
    args: 
      executable: /bin/bash
    register: result 
             
  - name: Record the application node name 
    set_fact:
      app_node: "{{ result.stdout }}"
  
  - name: Drain the application node
    shell: >
      kubectl drain {{ app_node }}
      --ignore-daemonsets --delete-local-data  --force
    args:
      executable: /bin/bash
    register: result
    until: "'cordoned' in result.stdout"
    delay: 20
    retries: 12

   # Get the rescheduled application pod name
  - name: Get the rescheduled application pod name
    shell: >
      kubectl get pods -n {{ a_ns }} -l {{ a_label }} --no-headers
      -o=custom-columns=NAME:".metadata.name"
    args:
      executable: /bin/bash
    register: pod_after_rescheduled

    # Do not untaint until evict occurs
  - name: Wait for application pod reschedule (evict)
    shell: >
      kubectl get pod {{ pod_after_rescheduled.stdout }} -n {{ app_ns }} 
      --no-headers -o custom-columns=:spec.nodeName
    args: 
      executable: /bin/bash
    register: node_after_rescheduled
    until: "node_after_rescheduled.stdout  != app_node"
    delay: 20
    retries: 12
   
  when: action == "drain"

- block:

  - name: Uncordon the application node
    shell: >
      kubectl uncordon {{ app_node }}
    args:
      executable: /bin/bash
    register: result
    until: "'uncordoned' in result.stdout"
    delay: 20
    retries: 12
    
  when: action == "uncordon"
