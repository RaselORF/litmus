--- 
- name: Get Instance Name to list the disks attached
  shell: >
    kubectl get pod {{ app }} -n {{ app_ns }}
    --no-headers -o custom-columns=:spec.nodeName
  args:
    executable: /bin/bash
  register: app_node

- name: Fetch AWS instance details
  include_tasks: /common/utils/aws/fetch_aws_details.yml
  when: lookup('env', 'PLATFORM') == 'AWS'

- name: Get EBS volume details 
  include_tasks: /chaoslib/aws_chaos/ebs_volume_operations.yml
  vars:
    action_on_volume: 'list'
  when: lookup('env', 'PLATFORM') == 'AWS'

- set_fact: filtered={{ result.volumes | json_query('[?attachment_set.device!=`/dev/sda1`]') }}

- set_fact: volume_id={{ item.id }}

- block:

    - name: Detach the disk from the node
      include_tasks: /chaoslib/aws_chaos/ebs_volume_operations.yml
      vars:
        action_on_volume: 'detach'
      when: lookup('env', 'PLATFORM') == 'AWS'

  when: action == "disk-fail"

- block:

    - name: Attach the disk to the node
      include_tasks: /chaoslib/aws_chaos/ebs_volume_operations.yml
      vars:
        action_on_volume: 'attach'
      when: lookup('env', 'PLATFORM') == 'AWS'

  when: action == "disk-recover"


