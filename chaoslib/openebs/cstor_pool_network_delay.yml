- name: Setup pumba chaos infrastructure
  shell: >
    kubectl apply -f /chaoslib/pumba/pumba_kube.yaml
    -n {{ ns }}
  args:
    executable: /bin/bash
  register: result 

- name: Confirm that the pumba ds is running on all nodes
  shell: >
    kubectl get pod -l app=pumba 
    --no-headers -o custom-columns=:status.phase
    -n {{ ns }} | sort | uniq
  args: 
    executable: /bin/bash
  register: result
  until: "result.stdout == 'Running'"
  delay: 20
  retries: 15  

- name: Getting the Application pod name
  shell:  kubectl get pods -n {{ ns }} -l {{ app_label }} --no-headers -o=custom-columns=NAME:".metadata.name"  
  register: pod_name

- name: Getting the node on which Application pod is scheduled
  shell: kubectl get pod {{ pod_name.stdout }} -n {{ ns }} -o jsonpath='{.spec.nodeName}'
  register: node

- name: Getting pool-pod on derived node
  shell: kubectl get pods -n {{ target_ns }} -l app=cstor-pool -o jsonpath='{.items[?(@.spec.nodeName=="{{ node.stdout }}")].metadata.name}'  
  register: pool_pod

- name: Installing tc package in cstor-pool container
  shell: kubectl exec -it {{ pool_pod.stdout }} -n {{ target_ns }} -c cstor-pool -- apt-get install iproute2 -y 
  register: install_status
  failed_when: "'Setting up iproute2' not in install_status.stdout"

- name: Getting the pumba pod name on derived node
  shell: >
    kubectl get pods -l app=pumba -n {{ ns }} 
    -o jsonpath='{.items[?(@.spec.nodeName==''"{{ node.stdout }}"'')].metadata.name}'
  args:
    executable: /bin/bash
  register: pumba_pod 

- name: Inject egress delay of {{network_delay}}ms on cstor target for {{ chaos_duration }}s
  shell: >
    kubectl exec {{ pumba_pod.stdout }} -n {{ ns }} 
    -- pumba netem --interface eth0 --duration {{ chaos_duration }}s delay
    --time {{ network_delay }} re2:k8s_cstor-pool_cstor-sparse-pool; 
  args:
    executable: /bin/bash  

- name: Wait for 10s post fault injection 
  wait_for:
    timeout: 10

- name: Delete the pumba daemonset 
  shell: kubectl delete -f /chaoslib/pumba/pumba_kube.yaml -n {{ ns }} 
  args:
    executable: /bin/bash
  register: result     

- name: Confirm that the pumba ds is deleted successfully
  shell: >
    kubectl get pods -l app=pumba --no-headers -n {{ ns }}
  args:
    executable: /bin/bash
  register: result
  until: "'Running' not in result.stdout"
  delay: 20
  retries: 15      

- name: Removing the tc package from cstor-pool
  shell: kubectl exec -it {{ pool_pod.stdout }} -n {{ target_ns }} -c cstor-pool -- apt-get purge iproute2 -y
  register: remove
  failed_when: "'Removing iproute2' not in remove.stdout"     