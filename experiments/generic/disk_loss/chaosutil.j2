# All code here is not indented because j2 is space sensitive

# checks if cloud_platform is set or not
{% if cloud_platform is defined and cloud_platform == 'GCP' or cloud_platform == 'AWS' %}
c_util: /chaoslib/litmus/disk_loss.yml
update_chaos_result: /utils/runtime/update_chaos_result_resource.yml
pod_status: /utils/common/status_app_pod.yml
gcp_disk_status: /utils/cloud/gcp/status_disk.yml
gcloud_config: /utils/cloud/gcp/gcloud_configure.yml
{% endif %}

# check if the status is set to check_gcp_disk or not
{% if status is defined and status == 'check_gcp_disk' %}
# Initially, it "inuse" set to false
{% set ns = namespace(inuse=false) %}
{% set expect_user = 'https://www.googleapis.com/compute/v1/projects/' + project_id + '/zones/' + zone_name + '/instances/' + node_name %}
# loop through all the disk users and checks if current_user is equal to expect_user
{% for current_user in disk_users.stdout_lines  %}
{% if current_user == expect_user %}
# If the condition is true, then set "inuse" to true
{% set ns.inuse = true %}
{% endif %}
{% endfor %}
{% if ns.inuse == true %}
inuse: true
{% else %}
inuse: false
{% endif %}
{% endif %}