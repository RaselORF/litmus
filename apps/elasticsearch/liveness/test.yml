---
- hosts: localhost
  connection: local

  vars_files:
    - vars.yml

  tasks:
    - block:
        - block:

            - name: Record test instance/run ID
              set_fact:
                run_id: "{{ lookup('env','RUN_ID') }}"

            - name: Construct testname appended with runID
              set_fact:
                test_name: "{{ test_name }}-{{ run_id }}"

          when: lookup('env','RUN_ID')
        
        ## RECORD START-OF-TEST IN LITMUS RESULT CR
        - include_tasks: /utils/fcm/update_litmus_result_resource.yml
          vars:
            status: 'SOT'

        - name: Getting the application pod name
          shell: kubectl get po -n {{ namespace }} -l {{ app_label }} -o jsonpath={.items[0].metadata.name}
          register: pod_name

        - name: Replacing the placeholder for pod-name
          replace:
            path: "{{ elasticsearch_liveness }}"
            regexp: "pod-name"
            replace: "{{ pod_name.stdout }}"   

        - name: Replacing the placeholder for namespace
          replace:
            path: "{{ elasticsearch_liveness }}"
            regexp: "app-namespace"
            replace: "{{ namespace }}"   

        - name: Replacing the placeholder for liveness-retry-count
          replace:
            path: "{{ elasticsearch_liveness }}"
            regexp: "liveness-retry-count"
            replace: "{{ liveness_retry }}"   

        - name: Replacing the placeholder for liveness-timeout
          replace:
            path: "{{ elasticsearch_liveness }}"
            regexp: "liveness-timeout-seconds"
            replace: "{{ liveness_timeout }}"   

        - name: Creating elasticsearch-liveness job
          shell: kubectl create -f {{ elasticsearch_liveness }} 

        - name: Verifying whether liveness pod is started successfully  
          shell: kubectl get pod -n {{ namespace }} -l liveness=elasticsearch-liveness -o jsonpath={.items[0].status.phase} 
          register: pod_status
          until: "'Running' in pod_status.stdout"
          delay: 60 
          retries: 20

        - set_fact:
            flag: "Pass"

      rescue:
        - set_fact:
            flag: "Fail"

      always:

        ## RECORD END-OF-TEST IN LITMUS RESULT CR
        - include_tasks: /utils/fcm/update_litmus_result_resource.yml
          vars:
            status: 'EOT'
        

